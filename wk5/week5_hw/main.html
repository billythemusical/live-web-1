<html>

<head>
    <script src="peer.min.js"></script>
    <script src="client.js"></script>
    <script src="/socket.io/socket.io.js"></script>


    <!--not using this right now; put in client.js-->
    <script type="text/javascript">
        //socket.on()

        // We'll use a global variable to hold on to our id from PeerJS
        var peer_id = null;

        // I setup a peer server on a Digital Ocean instance for our use, you can use that with the following constructor:
        var peer = new Peer({ host: 'liveweb-new.itp.io', port: 9000, path: '/' });


        // Get an ID from the PeerJS server
        peer.on('open', function (id) {
            console.log('My peer ID is: ' + id);
            peer_id = id;

            //get my id text area, display my peer id in the text area
            let myid_text = document.getElementById('mypeerid');
            myid_text.innerHTML = peer_id;
            //console.log('peer_id: ' + peer_id);
        });

        peer.on('error', function (err) {
            console.log(err);
        });

        peer.on('call', function (incoming_call) {
            console.log("Got a call!");
            incoming_call.answer(my_stream); // Answer the call with our stream from getUserMedia
            incoming_call.on('stream', function (remoteStream) {  // we receive a getUserMedia stream from the remote caller
                // And attach it to a video object
                var ovideoElement = document.createElement('video');
                // ovideoElemnt.id = "something";
                ovideoElement.srcObject = remoteStream;
                //ovideoElement.src = window.URL.createObjectURL(remoteStream) || remoteStream;
                ovideoElement.setAttribute("autoplay", "true");
                ovideoElement.play();
                document.body.appendChild(ovideoElement);
            });
        });

        function makeCall(idToCall) {
            var call = peer.call(idToCall, my_stream);

            call.on('stream', function (remoteStream) {
                console.log("Got remote stream");
                var ovideoElement = document.createElement('video');
                ovideoElement.srcObject = remoteStream;
                // ovideoElement.src = window.URL.createObjectURL(remoteStream) || remoteStream;
                ovideoElement.setAttribute("autoplay", "true");
                ovideoElement.play();
                document.body.appendChild(ovideoElement);
            });
        }

        /* Get User Media */
        let my_stream = null;

        // Constraints - what do we want?
        let constraints = { audio: false, video: true }

        window.addEventListener('load', function () {
            let socket = io.connect();

            ////////* STREAM PORTION *////////
            // Prompt the user for permission, get the stream
            navigator.mediaDevices.getUserMedia(constraints).then(function (stream) {
                /* Use the stream */

                // Attach to our video object
                var videoElement = document.getElementById('myvideo');
                videoElement.srcObject = stream;

                // Global for stream
                my_stream = stream;

                // Old way to write. Wait for the stream to load enough to play
                // videoElement.onloadedmetadata = function(e) {
                //     videoElement.play();
                // };

                videoElement.addEventListener('loadedmetadata', function (e) {
                    videoElement.play();
                });

            })
                .catch(function (err) {
                    /* Handle the error */
                    alert(err);
                });


            ////////* SOCKET CLIENT PORTION *////////
            socket.on('connect', function () {
                console.log("Connected");
            });
            
            //when submitbutton is pressed, perform sendPeerId function
            submitbutton = document.getElementById('submit');
            submitbutton.addEventListener('click', sendPeerID)

            //send my peer id
            function sendPeerID() {
                let mypeerid = document.getElementById('mypeerid').value;
                console.log("sending: " + mypeerid);

                //send the peer id to server (perform sendPeerID function on server side)
                socket.emit('sendPeerId', mypeerid);
            }

            // receive other peer id, then display in div
            socket.on('otherPeerId', function (data) {
                let otherDiv = document.getElementById('otherid-div');
                otherDiv.innerHTML += data;
                console.log("other peer id is received: " + data);
            })

        });
    </script>

    <style>
        textarea {
            background-color: pink;
            height: 5vh;
        }
        
        div{
            background-color: yellow;
        }
    </style>
</head>

<body>
    <p id='myid-label'>My Peer Id: </p> <br>
    <textarea id="mypeerid"></textarea><input type="submit" id='submit'><br>
    <p id='otherid-label'>Other Id's</p> <br>
    <div id="otherid-div"></div><br>

    <button id="connect">connect</button>

    <video id="myvideo"></video>
    <video id="othervideo"></video>
</body>

</html>



<!-- DUMPSTER CODE
                // Receive the other peerid
            // socket.on('peerid', function (data) {
            //     console.log("Got Peer ID: " + data);
            //     document.getElementById('otherid-div').innerHTML = data;
            // });

            function keyPressedUser(e) {
                // console.log(e);
                if (e.keyCode == 13) {
                    console.log('my username: ' + username.value);
                    let myUsername = username.value;
                    socket.emit('username', myUsername);
                }
            }

                function retrivePeerID() {
                //get my peer id from text area
                let peerid = document.getElementById('mypeerid').value;
                console.log("sending: " + othermessage);

                //send the peer id to server (perform sendPeerID function on server side)
                socket.emit('sendPeerId', peerid);
            }


        // socket.on('displayOtherPeerId', function (id) {
        //     otherPeerId = id;
        //     console.log('others peer id: ' + otherPeerId);
        //     displayPeerId(otherPeerId);
        // })

        // // listen for other's peer id
        // socket.on('send', function (id) {
        //     console.log("other peer id: " + id);
        // });

        // //get value send my peer id to server
        // let sendMyPeerId = function () {
		// 	var peerId = document.getElementById('myid-div').value;
		// 	console.log("Sending: " + peerId);

		// 	// Send a messaage
		// 	socket.send(peerId);
		// };

        // DISPLAY USERNAME
        function displayPeerId(id) {
            //show in other person's Div
            let otherDiv = document.getElementById('otherid-div');
            otherDiv.innerHTML = id;
        }

        function sendPeerID()
-->